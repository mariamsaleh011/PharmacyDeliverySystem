@model PharmacyDeliverySystem.Models.Order

@{
    ViewData["Title"] = "Invoice";
    Layout = "_Layout";

    decimal totalAmount = ViewBag.TotalAmount ?? 0m;
    bool isDelivered = Model.Status == "Delivered";
}

<div class="container my-5">
    <div id="invoiceCard" class="card shadow-lg mx-auto" style="max-width:900px;">
        <!-- ===== Header ===== -->
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div style="
    width:32px;
    height:32px;
    border-radius:8px;
    background: linear-gradient(135deg, #00b4db, #0083b0);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:16px;
">
                    P
                </div>

                <div>
                    <h4 class="mb-0">PharmacyMarts</h4>
                    <small class="text-muted">Digital Pharmacy Delivery Invoice</small>
                </div>
            </div>

            <div class="text-end">
                <div class="fw-semibold">Invoice</div>
                <div class="small text-muted">Order #@Model.OrderId</div>
                <div class="small text-muted">@DateTime.Now.ToString("dd/MM/yyyy")</div>
            </div>
        </div>

        <!-- ===== Body ===== -->
        <div class="card-body">
            <!-- Customer + QR -->
            <div class="row mb-4">
                <div class="col-md-7">
                    <h5 class="mb-3">Customer Details</h5>
                    <p class="mb-1"><strong>Name:</strong> @Model.Customer?.Name</p>
                    <p class="mb-1">
                        <strong>Status:</strong>
                        <span id="orderStatus">@Model.Status</span>
                    </p>
                    <p class="mb-1">
                        <strong>Total Amount:</strong>
                        @totalAmount.ToString("0.00 ج.م")
                    </p>
                </div>

                <div class="col-md-5 text-center">
                    <h5 class="mb-3">QR Code</h5>
                    @if (!string.IsNullOrEmpty(ViewBag.QRCodeImage))
                    {
                        <img id="qrCodeImage"
                             src="@ViewBag.QRCodeImage"
                             alt="QR Code"
                             class="img-fluid border rounded"
                             style="max-width:220px;"
                             data-order-id="@Model.OrderId" />

                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="downloadQRCode()">
                                Download QR Code
                            </button>
                        </div>
                    }

                    <div class="mt-3">
                        <label class="form-label">Scan QR (upload image)</label>
                        <input type="file"
                               id="qrUpload"
                               accept="image/*"
                               class="form-control form-control-sm" />
                        <small id="scanResult" class="form-text"></small>
                    </div>
                </div>
            </div>

            <!-- Items -->
            <h5 class="mb-3">Items</h5>

            @if (Model.OrderItems != null && Model.OrderItems.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th class="text-center" style="width:120px;">Quantity</th>
                                <th class="text-end" style="width:150px;">Unit Price</th>
                                <th class="text-end" style="width:150px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.OrderItems)
                            {
                                var qty = item.Quantity ?? 0;
                                var unitPrice = item.Price ?? 0m;
                                var lineTotal = qty * unitPrice;

                                <tr>
                                    <td>@item.Product?.Name</td>
                                    <td class="text-center">@qty</td>
                                    <td class="text-end">@unitPrice.ToString("0.00 ج.م")</td>
                                    <td class="text-end">@lineTotal.ToString("0.00 ج.م")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Total</th>
                                <th class="text-end">@totalAmount.ToString("0.00 ج.م")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">No items to display.</p>
            }

            <!-- ===== Rating (Stars) ===== -->
            <div id="ratingSection" class="mt-4" style="display:@(isDelivered ? "block" : "none")">
                <h5>Rate this order</h5>

                <input type="hidden" id="ratingValue" value="@(Model.Rating ?? 0)" />

                <div class="star-rating" style="font-size:32px; cursor:pointer; user-select:none;">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var color = (Model.Rating.HasValue && Model.Rating >= i) ? "gold" : "#ccc";
                        <span class="star"
                              data-value="@i"
                              style="color:@color; margin-right:6px;">
                            ★
                        </span>
                    }
                </div>

                <button id="submitRating"
                        type="button"
                        class="btn btn-success btn-sm mt-3">
                    Submit Rating
                </button>
            </div>
        </div>

        <!-- ===== Footer ===== -->
        <div class="card-footer d-flex justify-content-between">
            <div class="small text-muted">
                Generated on @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="printInvoice()">
                    Print
                </button>
                <button class="btn btn-primary btn-sm" type="button" onclick="saveInvoice()">
                    Save as PDF
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- jsQR لازم يبقى موجود للـ QR decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

    <script>
        (function () {
            const qrInput = document.getElementById("qrUpload");
            const scanResult = document.getElementById("scanResult");
            const orderStatus = document.getElementById("orderStatus");
            const ratingSection = document.getElementById("ratingSection");

            // ===== QR Scan via image upload =====
            if (qrInput) {
                qrInput.addEventListener("change", function () {
                    const file = this.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function () {
                        const img = new Image();
                        img.src = reader.result;
                        img.onload = function () {
                            const canvas = document.createElement("canvas");
                            const ctx = canvas.getContext("2d");
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, canvas.width, canvas.height);

                            if (code) {
                                scanResult.classList.remove("text-danger");
                                scanResult.classList.add("text-success");
                                scanResult.innerText = "✅ QR detected, updating order...";

                                fetch('/QrConfirmation/ConfirmDelivery?qrData=' + encodeURIComponent(code.data))
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.success) {
                                            scanResult.innerText = "✅ Order marked as Delivered";
                                            if (orderStatus) orderStatus.innerText = "Delivered";
                                            if (ratingSection) ratingSection.style.display = "block";
                                        } else {
                                            scanResult.classList.remove("text-success");
                                            scanResult.classList.add("text-danger");
                                            scanResult.innerText = "❌ Failed to update order";
                                        }
                                    })
                                    .catch(() => {
                                        scanResult.classList.remove("text-success");
                                        scanResult.classList.add("text-danger");
                                        scanResult.innerText = "❌ Error calling server";
                                    });
                            } else {
                                scanResult.classList.remove("text-success");
                                scanResult.classList.add("text-danger");
                                scanResult.innerText = "❌ No QR detected";
                            }
                        };
                    };
                    reader.readAsDataURL(file);
                });
            }

            // ===== Stars rating logic =====
            const stars = document.querySelectorAll(".star");
            const ratingValue = document.getElementById("ratingValue");
            const submitBtn = document.getElementById("submitRating");

            if (stars && ratingValue) {
                stars.forEach(star => {
                    star.addEventListener("click", function () {
                        const value = parseInt(this.dataset.value);
                        ratingValue.value = value;
                        stars.forEach(s => {
                            const v = parseInt(s.dataset.value);
                            s.style.color = (v <= value) ? "gold" : "#ccc";
                        });
                    });
                });
            }

            // ===== Submit rating =====
            if (submitBtn && ratingValue) {
                submitBtn.addEventListener("click", function () {
                    const rating = parseInt(ratingValue.value);
                    if (!rating || rating < 1 || rating > 5) {
                        alert("Please select stars first!");
                        return;
                    }

                 const orderId = parseInt('@Model.OrderId');

                    fetch('/QrConfirmation/SubmitRating', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId: orderId, rating: rating })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                alert("Thank you for rating!");
                                submitBtn.disabled = true;
                            } else {
                                alert("Error submitting rating");
                            }
                        })
                        .catch(() => {
                            alert("Error submitting rating");
                        });
                });
            }

            // ===== Download QR =====
            window.downloadQRCode = function () {
                const img = document.getElementById("qrCodeImage");
                if (!img) return;
                const link = document.createElement("a");
                link.href = img.src;
                link.download = "invoice-qrcode-order-@(Model.OrderId).png";
                link.click();
            };

            // ===== Print / Save as PDF =====
            window.printInvoice = function () {
                window.print();
            };

            window.saveInvoice = function () {
                // عملياً هي هي: المستخدم يختار Save as PDF من الـ Print Dialog
                window.print();
            };
        })();
    </script>
}
