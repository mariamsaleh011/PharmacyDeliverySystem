@model PharmacyDeliverySystem.Models.Order

@{
    ViewData["Title"] = "Invoice";
    Layout = "_Layout";

    decimal totalAmount = ViewBag.TotalAmount ?? 0m;

    bool isPharmacy = User.IsInRole("Pharmacy");
    bool isCustomer = User.IsInRole("Customer");
}

<div class="container my-5">
    <div id="invoiceCard" class="card shadow-lg mx-auto" style="max-width: 900px;">
        <!-- ===== Header / Brand ===== -->
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div style="
                        width:32px;height:32px;
                        border-radius:8px;
                        background:#16a34a;
                        display:flex;align-items:center;justify-content:center;
                        color:#fff;font-weight:700;">
                    P
                </div>
                <div>
                    <h4 class="mb-0">PharmacyMarts</h4>
                    <small class="text-muted">Digital Pharmacy Delivery Invoice</small>
                </div>
            </div>

            <div class="text-end">
                <div class="fw-semibold">Invoice</div>
                <div class="small text-muted">Order #@Model.OrderId</div>
                <div class="small text-muted">@DateTime.Now.ToString("dd/MM/yyyy")</div>
            </div>
        </div>

        <!-- ===== Body ===== -->
        <div class="card-body">
            <!-- Customer / QR row -->
            <div class="row mb-4">
                <div class="col-md-7">
                    <h5 class="mb-3">Customer Details</h5>

                    <p class="mb-1">
                        <strong>Name:</strong>
                        @Model.Customer?.Name
                    </p>
                    <p class="mb-1">
                        <strong>Status:</strong>
                        <span id="orderStatus">@Model.Status</span>
                    </p>
                    <p class="mb-1">
                        <strong>Total Amount:</strong>
                        @totalAmount.ToString("0.00 ج.م")
                    </p>
                </div>

                @if (!string.IsNullOrEmpty(ViewBag.QRCodeImage))
                {
                    <div class="col-md-5 text-center">
                        <h5 class="mb-3">QR Code</h5>
                        <img id="qrCodeImage"
                             src="@ViewBag.QRCodeImage"
                             alt="QR Code"
                             class="img-fluid border rounded"
                             style="max-width: 220px;"
                             data-order-id="@Model.OrderId" />
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm mt-3"
                                onclick="downloadQRCode()">
                            Download QR Code
                        </button>

                        <!-- ===== Scan QR Image Upload ===== -->
                        <div class="mt-3">
                            <input type="file" id="qrUpload" accept="image/*" class="form-control form-control-sm" />
                            <p id="scanResult" class="mt-2 text-success fw-bold"></p>
                        </div>
                    </div>
                }
            </div>

            <!-- Items table -->
            <h5 class="mb-3">Items</h5>

            @if (Model.OrderItems != null && Model.OrderItems.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th class="text-center" style="width:120px;">Quantity</th>
                                <th class="text-end" style="width:150px;">Unit Price</th>
                                <th class="text-end" style="width:150px;">Line Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.OrderItems)
                            {
                                var qty = item.Quantity ?? 0;
                                var unitPrice = item.Price ?? 0m;
                                var lineTotal = qty * unitPrice;

                                <tr>
                                    <td>@item.Product?.Name</td>
                                    <td class="text-center">@qty</td>
                                    <td class="text-end">@unitPrice.ToString("0.00 ج.م")</td>
                                    <td class="text-end">@lineTotal.ToString("0.00 ج.م")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Total</th>
                                <th class="text-end">@totalAmount.ToString("0.00 ج.م")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">No items to display.</p>
            }

            <!-- ===== Rating Section (Stars only) ===== -->
            <div id="ratingSection" class="mt-4" style="display:none;">
                <h5>Rate this Order</h5>
                <div class="stars" style="font-size: 30px; color:#ccc; cursor:pointer;">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <span class="star" data-value="@i">★</span>
                    }
                </div>
                <input type="hidden" id="ratingValue" value="0" />
                <button type="button"
                        id="submitRating"
                        class="btn btn-success btn-sm mt-2"
                        onclick="submitRating(@Model.OrderId)">
                    Submit Rating
                </button>
            </div>
        </div>

        <!-- ===== Footer / Actions ===== -->
        <div class="card-footer d-flex justify-content-between">
            <div class="text-muted small align-self-center">
                Generated on @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
            </div>

            <div class="d-flex gap-2">
                @* Customer: Save (Print dialog → Save as PDF) *@
                @if (isCustomer || (!isCustomer && !isPharmacy))
                {
                    <button type="button"
                            class="btn btn-primary"
                            onclick="saveInvoice()">
                        Save Invoice
                    </button>
                }

                @* Pharmacy: Print *@
                @if (isPharmacy)
                {
                    <button type="button"
                            class="btn btn-outline-secondary"
                            onclick="printInvoice()">
                        Print Invoice
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* jsQR لازم يبقى قبل invoice.js *@
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script src="~/js/invoice.js" asp-append-version="true"></script>
}
