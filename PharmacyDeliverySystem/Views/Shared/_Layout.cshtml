<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - PharmacyDeliverySystem</title>

    <script type="importmap"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <!-- ستايل عام للموقع (فيه التوب بار، السلة، زر الرجوع لأعلى، الثيم، ... ) -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <!-- ستايلات الـ Razor اللي السكافولد بيولدها -->
    <link rel="stylesheet" href="~/PharmacyDeliverySystem.styles.css" asp-append-version="true" />

    @RenderSection("Head", required: false)
</head>
<body>
    <!-- Topbar / Navbar الموحد لكل الصفحات -->
    <header class="topbar">
        <div class="topbar-inner">
            <!-- Logo -->
            <div class="logo">
                <div class="logo-mark" aria-hidden="true"></div>
                <div>Pharmacy<span>Marts</span></div>
            </div>

            <!-- Searchbar -->
            <div class="searchbar">
                <form asp-area=""
                      asp-controller="Home"
                      asp-action="Search"
                      method="get"
                      class="search-form"
                      id="globalSearchForm">

                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="7"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>

                    <input id="searchInput"
                           name="query"
                           type="text"
                           placeholder="ابحث في الباقات والمنتجات..."
                           aria-label="بحث"
                           autocomplete="off" />

                    <!-- زر مخفي لتضمن أن Enter يعمل في كل المتصفحات -->
                    <button type="submit" style="display:none" aria-hidden="true">Search</button>
                </form>
            </div>

            <!-- Nav + Actions -->
            <div class="topbar-right">
                <!-- روابط الصفحات الأساسية -->
                <nav class="main-nav">
                    <a asp-area=""
                       asp-controller="Home"
                       asp-action="Index">
                        الرئيسية
                    </a>

                    <a asp-controller="Drugs"
                       asp-action="Index">
                        الأدوية
                    </a>

                    <a asp-controller="BabyCare"
                       asp-action="Index">
                        عناية الأطفال
                    </a>

                    <a asp-controller="MenCare"
                       asp-action="Index">
                        عناية الرجال
                    </a>

                    <a asp-controller="Chat"
                       asp-action="Index">
                        Chat مع الصيدلي
                    </a>

                    <a asp-area=""
                       asp-controller="Home"
                       asp-action="Privacy">
                        Privacy
                    </a>
                </nav>

                <!-- أكشنز: Login/Logout + ثيم + سلة -->
                <div class="top-actions">

                    @* Login / Logout *@
                    @if (User.Identity != null && User.Identity.IsAuthenticated)
                    {
                        <form asp-controller="CustomerAuth"
                              asp-action="Logout"
                              method="post"
                              class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-outline-danger btn-sm">
                                Logout
                            </button>
                        </form>
                    }
                    else
                    {
                        <a class="login-btn nav-link"
                           asp-controller="CustomerAuth"
                           asp-action="Login">
                            Login
                        </a>
                    }

                    <button id="themeToggle"
                            class="icon-btn"
                            type="button"
                            title="الوضع"
                            aria-label="تبديل الوضع">
                        ☾
                    </button>

                    <button id="cartBtn"
                            class="icon-btn"
                            type="button"
                            title="السلة"
                            aria-label="فتح السلة">
                        🛒
                        <span id="cartCount" class="badge" aria-live="polite">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- محتوى الصفحات -->
    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <!-- Footer -->
    <footer class="border-top footer text-muted main-footer">
        <div class="container">
            <span>
                &copy; 2025 - PharmacyDeliverySystem - جميع الحقوق محفوظة
            </span>
            |
            <a asp-area=""
               asp-controller="Home"
               asp-action="Privacy">
                Privacy
            </a>
        </div>
    </footer>

    <!-- زر الرجوع لأعلى -->
    <button id="toTop" type="button" title="أعلى الصفحة">↑</button>

    <!-- Overlay + Drawer بتوع السلة -->
    <div id="overlay" class="overlay" onclick="toggleCart(false)"></div>

    <aside id="drawer" class="drawer" aria-label="سلة المشتريات" aria-live="polite">
        <div class="drawer-header">
            <strong>سلة المشتريات</strong>
            <button class="icon-btn" type="button" onclick="toggleCart(false)" aria-label="إغلاق">✕</button>
        </div>

        <div id="cartList" class="drawer-body"></div>

        <div class="drawer-footer">
            <div class="drawer-total-row">
                <span>الإجمالي:</span>
                <strong id="cartTotal">0 ج.م</strong>
            </div>

            <!-- 👇 زرار الـ Checkout متظبط مع الـ JS -->
            <button id="checkoutBtn"
                    type="button"
                    onclick="checkout()"
                    data-is-authenticated="@(User?.Identity?.IsAuthenticated == true ? "true" : "false")"
                    data-login-url="@Url.Action("Login", "CustomerAuth")">
                Checkout
            </button>

            <button type="button"
                    class="btn btn-danger w-100"
                    onclick="clearCart()">
                تفريغ السلة
            </button>
        </div>
    </aside>

    <!-- سكربتات أساسية -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <!-- سكربت بحث الهيدر -->
    <script>
        (function () {
            var input = document.getElementById('searchInput');
            var form = document.getElementById('globalSearchForm');

            if (!input || !form) return;

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    var q = input.value && input.value.trim();
                    if (!q) return;

                    try {
                        var actionUrl = '@Url.Action("Search", "Home", new { area = "" })';
                        window.location.href = actionUrl + '?query=' + encodeURIComponent(q);
                    } catch (err) {
                        window.location.href = '/Home/Search?query=' + encodeURIComponent(q);
                    }

                    e.preventDefault();
                }
            });

            form.addEventListener('submit', function (e) {
                var q = input.value && input.value.trim();
                if (!q) {
                    e.preventDefault();
                }
            });
        })();
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
