@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Product Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Head {
    <link rel="stylesheet" href="~/css/product-admin.css" asp-append-version="true" />
}

<div class="admin-wrapper">
    <section class="prod-card">
        <header class="prod-card__header">
            <div class="header-title">
                <div class="logo-icon admin-logo">
                    <img src="@(Url.Content("~/images/icons/medicine-logo.svg"))"
                         asp-append-version="true"
                         alt="PharmacyMarts"
                         class="logo-img" />
                </div>

                <div>
                    <h1>Product Management</h1>
                    <p class="subtitle">View and manage all products in stock</p>
                </div>
            </div>

            <div class="prod-actions">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input id="prodSearch" type="search" placeholder="Quick search..." />
                </div>

                <button class="btn btn-primary" id="btnAddProduct">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>New Product</span>
                </button>

                <a href="@Url.Action("Chats", "PharmacyChat")" class="btn btn-info" style="margin-left:10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Chat
                </a>
            </div>
        </header>

        <div class="table-container">
            <table class="prod-table" id="productsTable">
                <thead>
                    <tr>
                        <th width="80">Product</th>
                        <th>Name / Description</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var p in Model)
                        {
                            string rawId = "";
                            string rawName = "";
                            string rawDesc = "";
                            string rawImg = "";
                            decimal price = 0;
                            decimal oldPrice = 0;
                            int quantity = 0;
                            bool isActive = false;

                            try { rawId = Convert.ToString(p.Id); } catch { }
                            try { rawName = Convert.ToString(p.Name); } catch { }
                            try { rawDesc = Convert.ToString(p.Description); } catch { }
                            try { rawImg = Convert.ToString(p.ImageUrl); } catch { }
                            try { price = Convert.ToDecimal(p.Price); } catch { }
                            try
                            {
                                var op = p.OldPrice;
                                if (op != null && !Convert.IsDBNull(op))
                                    oldPrice = Convert.ToDecimal(op);
                            }
                            catch { }
                            try { quantity = Convert.ToInt32(p.Quantity); } catch { }
                            try { isActive = Convert.ToBoolean(p.IsActive); } catch { }

                            <tr data-id="@rawId" data-active="@(isActive ? "true" : "false")">
                                <td>
                                    <div class="img-wrapper">
                                        @if (!string.IsNullOrEmpty(rawImg))
                                        {
                                            <!-- لو فيه صورة، استخدمها ولو فشلت رجّع الـ default SVG -->
                                            <img src="@rawImg"
                                                 alt="@rawName"
                                                 class="prod-thumb"
                                                 onerror="this.onerror=null; this.src='@Url.Content("~/images/icons/product-default.svg")';" />
                                        }
                                        else
                                        {
                                            <!-- لو مفيش صورة، اعرض الـ default SVG مباشرة -->
                                            <img src="@(Url.Content("~/images/icons/product-default.svg"))"
                                                 asp-append-version="true"
                                                 alt="Default product"
                                                 class="prod-thumb default-icon" />
                                        }
                            </div>
                        </td>

                        <td>
                            <div class="cell-content">
                                <strong class="prod-name">@rawName</strong>
                                <span class="prod-desc-preview">
                                    @(!string.IsNullOrEmpty(rawDesc) && rawDesc.Length > 30
                                                                        ? rawDesc.Substring(0, 30) + "..."
                                                                        : rawDesc)
                                </span>
                                <span class="prod-desc-full" style="display:none;">@rawDesc</span>
                            </div>
                        </td>

                                <td>
                                    <div class="price-cell">
                                        <span class="current-price">
                                            @price.ToString("N2") <small>EGP</small>
                                        </span>
                                @if (oldPrice > price)
                                        {
                                            <span class="old-price">@oldPrice.ToString("N2")</span>
                                        }
                                    </div>
                                </td>

                                <td class="prod-qty">@quantity</td>

                                <td>
                                    @if (isActive)
                                    {
                                        <span class="badge badge-active">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-inactive">Inactive</span>
                                    }
                                </td>

                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn-icon edit-btn" title="Edit" aria-label="Edit">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                 stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                 stroke-linejoin="round">
                                                <path d="M12 20h9"></path>
                                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 20l-4 1 1-4L16.5 3.5z"></path>
                                            </svg>
                                        </button>

                                        <button type="button" class="btn-icon delete-btn" title="Delete" aria-label="Delete">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                 stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                 stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr class="empty-state">
                            <td colspan="6">
                                <div class="empty-content">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none"
                                         stroke="#4b5563" stroke-width="1.5" stroke-linecap="round"
                                         stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                    </svg>
                                    <p>No products added yet.</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
</div>

<div id="productModal" class="modal" aria-hidden="true">
    <div class="modal-overlay"></div>
    <div class="modal-dialog">
        <form id="productForm" enctype="multipart/form-data" method="post"
              data-create-url="@Url.Action("Create","Admin")"
              data-edit-url="@Url.Action("Edit","Admin")">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ProId" id="prodId" />

            <div class="modal-header">
                <h2 id="modalTitle">Add / Edit Product</h2>
                <button type="button" class="btn-close" id="closeModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-grid">
                    <div class="image-upload-section">
                        <label class="image-preview-box" for="prodImage">
                            <img id="imagePreview" src="/images/image-placeholder.png" alt="Preview"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                            <div class="preview-placeholder-icon" style="display:none;"></div>

                            <div class="upload-overlay">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                     stroke="#fff" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                <span>Change image</span>
                            </div>
                        </label>
                        <input type="file" name="ImageFile" id="prodImage" accept="image/*" hidden />
                    </div>

                    <div class="inputs-section">
                        <div class="form-group">
                            <label for="prodName">Product name</label>
                            <input type="text" name="Name" id="prodName" class="form-control" required
                                   placeholder="e.g. Paracetamol 500mg" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prodPrice">Price (EGP)</label>
                                <input type="number" name="Price" id="prodPrice" class="form-control"
                                       step="0.01" min="0" required />
                            </div>
                            <div class="form-group">
                                <label for="prodOldPrice">Old price <small>(optional)</small></label>
                                <input type="number" name="OldPrice" id="prodOldPrice" class="form-control"
                                       step="0.01" min="0" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prodQty">Quantity in stock</label>
                                <input type="number" name="Quantity" id="prodQty" class="form-control"
                                       min="0" value="0" />
                            </div>
                            <div class="form-group">
                                <label for="prodActive">Status</label>
                                <select name="IsActive" id="prodActive" class="form-control">
                                    <option value="true">Active (visible to customers)</option>
                                    <option value="false">Inactive (hidden)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="prodDesc">Product description</label>
                            <textarea name="Description" id="prodDesc" class="form-control" rows="3"
                                      placeholder="Write a short description..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prodBarcode">Barcode</label>
                                <input type="text" name="Barcode" id="prodBarcode" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="prodBrand">Brand</label>
                                <input type="text" name="Brand" id="prodBrand" class="form-control" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prodVat">VAT rate</label>
                                <input type="number" name="VatRate" id="prodVat" class="form-control"
                                       step="0.01" />
                            </div>
                            <div class="form-group">
                                <label for="prodDosage">Dosage</label>
                                <input type="text" name="Dosage" id="prodDosage" class="form-control" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prodDrugType">Drug type</label>
                                <input type="text" name="DrugType" id="prodDrugType" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="prodPharmId">Pharmacy Id</label>
                                <input type="number" name="PharmId" id="prodPharmId" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" id="cancelProductBtn">Cancel</button>
                <button class="btn btn-primary" type="submit" id="saveProductBtn">
                    <span>Save changes</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal" aria-hidden="true">
    <div class="modal-overlay"></div>
    <div class="modal-dialog modal-sm">
        <div class="modal-header">
            <h2 class="text-danger">Confirm delete</h2>
            <button type="button" class="btn-close" id="closeConfirmBtn">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete product: <strong id="deleteItemName"></strong>?</p>
            <p class="text-muted text-sm">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteActionBtn">Yes, delete</button>
        </div>
    </div>
</div>

<form id="deleteForm" asp-controller="Admin" asp-action="Delete" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" id="deleteId" name="id" />
</form>

<div id="toastContainer" class="toast-container"></div>

@section Scripts {
    <script src="~/js/product-admin.js" asp-append-version="true"></script>
}
